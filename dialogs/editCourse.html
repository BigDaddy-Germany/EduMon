<header>
	<h2>Edit Course</h2>
	<h3>Please insert your content here</h3>
</header>
	Please insert data etc.:<br><br>
	Course name: <input type="text" id="courseName"><br><br>
	Members:<br>


	<div class="courseMemberLine">
		Name: <input type="text" class="courseMemberName">
		Group <input type="text" class="courseMemberGroup">
		<span class="courseMemberDelete">[-]</span>
	</div>
	<div id="courseMemberAdd">[+]</div>

	<br><br>
	<span id="courseCsvImport">[CSV Import]</span>
<footer>
	<button id="dialogBtnBack" type="button" class="btn btn-default">Abort</button>
	<button id="dialogBtnSubmit" type="button" class="btn btn-primary">Save Data</button>
</footer>

<script type="text/javascript">
	$(function() {

		/**
		 * Deletes a member row out of the form
		 * @param {Event} event the event triggered by the click on the minus button
		 */
		function deleteMember(event) {
			var member = $(event.target).parent();

			var lineCount = $('.courseMemberLine').length;
			if (lineCount > 1) {
				member.remove();

				if (lineCount == 2) {
					$('.courseMemberDelete').css('display', 'none');
				}
			}
		}

		/**
		 * Adds a new line to the form
		 */
		function addLine() {
			var lastLine = $('.courseMemberLine').last();
			lastLine.after(lastLine[0].outerHTML);

			// set the delete listeners and make the button visible again (at least one additional field, yet)
			$('.courseMemberDelete')
					.css('display', '')
					.off('click')
					.on('click', deleteMember);
		}

		/**
		 * Creates an object to stash the current data
		 * @return {Object} the object containing all the data
		 */
		function createStashObject() {
			// stash data at first
			var stashedData = {};
			stashedData.courseName = $('#courseName').val();

			stashedData.names = [];
			stashedData.groups = [];

			$('.courseMemberName').each(function() {
				stashedData.names.push($(this).val());
			});
			$('.courseMemberGroup').each(function() {
				stashedData.groups.push($(this).val());
			});

			return stashedData;
		}

		/**
		 * Restores the given stashed data to fill the fields again
		 * @param {Object} stashedData the data stashed before
		 */
		function restoreStashedData(stashedData) {
			if (stashedData) {
				$('#courseName').val(stashedData.courseName);
					
				for (var i = 1; i < stashedData.names.length; ++i) {
					addLine();
				}

				$('.courseMemberName').each(function (i) {
					$(this).val(stashedData.names[i]);
				});
				$('.courseMemberGroup').each(function (i) {
					$(this).val(stashedData.groups[i]);
				});
			}
		}

		// add new lines to the member form by clicking on the add button
		$('#courseMemberAdd').on('click', addLine);

		// set the delete listeners
		$('.courseMemberDelete').on('click', deleteMember);

		// listener to import csv data
		$('#courseCsvImport').on('click', function() {

			EduMon.UserInteraction.openStackedDialog(
					createStashObject(),
					EduMon.UserInteraction.importCsvContent,
					[])
					.then(function(data) {
						restoreStashedData(data[0]);
						console.log(data[1]);
					})
					.catch(function(data) {
						restoreStashedData(data[0]);
						console.log(data[1]);
					});

		});
	})
</script>