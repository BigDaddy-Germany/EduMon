<!DOCTYPE html>
<html>
    <head>
        <title>Lunch Wheel</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script src="lib/jquery/js/jquery.min.js"></script>
        <script src="lib/excanvas/js/excanvas.js"></script>
        <script src="js/EduMon.Math.js"></script>
        <script src="js/EduMon.Util.js"></script>
        <script src="js/EduMon.Wheel.js"></script>
        <script src="js/EduMon.XWindowRPC.js"></script>
    </head>
    <body>
        <div id="wheel">
            <canvas id="canvas" width="1000" height="600"></canvas>
        </div>
        <script>
			var KEY = {
				ENTER: 32
			};


			var modes = {
				slim: function(segment) {
					// half the weight of the selected segment
					segment[1] *= .1;

					// keep the weights in a stable range by keeping the smallest segment at weight 1 and scaling all other weights accordingly
					var min = EduMon.Math.extremeValue(segments, function(a, b) { return b[1] - a[1]});
					if (min[1] < 1) {
						var factor = 1 / min[1];
						for (var i = 0; i < segments.length; ++i) {
							segments[i][1] *= factor;
						}
					}

					console.log("" + segments);
				},
				drop: function(segment) {
					segments.splice(segments.indexOf(segment), 1);
				},
				noop: function() {}
			};

            var canvas = $('canvas');
			var wheel;

            var task = -1;
			var minDelay = 2000;
			var start = -1;
			$(window).on('keydown', function(e) {
				if (e.which === KEY.ENTER && start < 0 && task === -1) {
					wheel.beginSpinning();
					start = Date.now();
				}
			}).on('keyup', function(e) {
				if (e.which === KEY.ENTER && start >= 0 && task === -1) {
					var now = Date.now();
					var delta = now - start;
					console.log(" " + start + "\n+ " + now + " = " + delta);
                    if (delta < minDelay) {
                        task = setTimeout(function () {
                            wheel.endSpinning();
                            task = -1;
                        }, minDelay - delta);
                    } else {
                        wheel.endSpinning();
                    }
                    start = -1;
                }
			});

			if (window.opener) {
				var controller = new EduMon.XWindowRPC(window.opener, {
					showWheel: function (mode, segments) {
						if (!(mode in modes)) {
							throw "Unknown mode " + mode;
						}
						mode = modes[mode];
						wheel = new EduMon.Wheel(canvas[0], segments, function (segment) {
							controller.invoke("wheelFinished", segment[0]);
							mode(segment);
						});
					}
				});
			} else {
				var segments = [
					['Phillip Schichtel', 1.0],
					['Jonas Dann', 1.0],
					['Marco DÃ¶rfler', 1.0],
					['Niko Berkmann', 1.0],
					['Tim Adamek', 1.0],
					['Andreas Geis', 1.0],
					['Nick Steyer', 1.0],
					['Laura Hildebrand', 1.0],
					['Steffanie XXXXXXXX', 1.0],
					['Petra XXXXXXXXX', 1.0],
					['Inga XXXXXXXX', 1.0],
					['Marvin Klose', 1.0],
					['Michael Wienecke', 1.0],
					['Ricardo Bischof', 1.0]
				];

				wheel = new EduMon.Wheel(canvas[0], segments, function(segment) {
					//modes.half(segment);
					modes.drop(segment);
				});
			}
        </script>
    </body>
</html>
